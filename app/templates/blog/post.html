{% extends "base.html" %}

{% block title %}{{ post.title }} - Blog - {{ config.SITE_NAME }}{% endblock %}

{% block meta_description %}{{ post.meta_description or post.excerpt or (post.content[:160] + '...' if post.content|length > 160) }}{% endblock %}

{% block meta_keywords %}{{ post.meta_keywords or 'programming, development, technology, blog' }}{% endblock %}

{% block content %}
<div class="container mx-auto px-4 py-8">
    <!-- Back Navigation -->
    <div class="mb-6">
        <a href="{{ url_for('blog.index') }}" 
           class="terminal-secondary hover:terminal-primary transition-colors">
            <i class="fas fa-arrow-left mr-2"></i>
            Back to Blog
        </a>
    </div>
    
    <!-- Blog Post -->
    <article class="terminal-window mb-12">
        <div class="terminal-header">
            <div class="flex items-center space-x-4">
                <div class="terminal-controls">
                    <div class="terminal-control control-close"></div>
                    <div class="terminal-control control-minimize"></div>
                    <div class="terminal-control control-maximize"></div>
                </div>
                <span class="terminal-primary text-sm font-bold">
                    <i class="fas fa-file-alt mr-2"></i>
                    {{ post.slug }}.md
                </span>
            </div>
            <div class="terminal-muted text-xs">
                {{ post.published_at.strftime('%Y-%m-%d %H:%M') if post.published_at }}
            </div>
        </div>
        
        <div class="p-8">
            <!-- Post Header -->
            <header class="mb-8">
                <h1 class="text-4xl font-bold terminal-primary neon-glow mb-4 typing">
                    {{ post.title }}
                </h1>
                
                <!-- Post Meta -->
                <div class="flex flex-wrap items-center gap-4 text-sm terminal-muted mb-6">
                    <span>
                        <i class="fas fa-calendar mr-1"></i>
                        {{ post.published_at.strftime('%B %d, %Y') if post.published_at }}
                    </span>
                    <span>
                        <i class="fas fa-clock mr-1"></i>
                        {{ post.reading_time }} min read
                    </span>
                    <span>
                        <i class="fas fa-eye mr-1"></i>
                        {{ post.view_count }} views
                    </span>
                    {% if post.author %}
                    <span>
                        <i class="fas fa-user mr-1"></i>
                        {{ post.author.username }}
                    </span>
                    {% endif %}
                </div>
                
                <!-- Tags -->
                {% if post.tags %}
                <div class="flex flex-wrap gap-2 mb-6">
                    {% for tag in post.tags %}
                    <a href="{{ url_for('blog.tag', slug=tag.slug) }}" 
                       class="px-3 py-1 bg-gray-800 border border-gray-600 text-sm terminal-secondary rounded-full hover:border-green-400 hover:terminal-primary transition-colors">
                        #{{ tag.name }}
                    </a>
                    {% endfor %}
                </div>
                {% endif %}
            </header>
            
            <!-- Post Content -->
            <div class="prose prose-invert prose-green max-w-none">
                <div class="terminal-text leading-relaxed" id="post-content">
                    {{ post.content | markdown }}
                </div>
            </div>
            
            <!-- Post Footer -->
            <footer class="mt-12 pt-8 border-t border-gray-700">
                <div class="flex flex-wrap items-center justify-between">
                    <div class="text-sm terminal-muted">
                        Last updated: {{ post.updated_at.strftime('%B %d, %Y') }}
                    </div>
                    
                    <!-- Share Buttons -->
                    <div class="flex items-center space-x-4">
                        <span class="text-sm terminal-muted">Share:</span>
                        <a href="https://twitter.com/intent/tweet?text={{ post.title | urlencode }}&url={{ request.url | urlencode }}" 
                           target="_blank" 
                           class="terminal-secondary hover:terminal-primary transition-colors">
                            <i class="fab fa-twitter"></i>
                        </a>
                        <a href="https://www.linkedin.com/sharing/share-offsite/?url={{ request.url | urlencode }}" 
                           target="_blank" 
                           class="terminal-secondary hover:terminal-primary transition-colors">
                            <i class="fab fa-linkedin"></i>
                        </a>
                        <button onclick="copyToClipboard('{{ request.url }}')" 
                                class="terminal-secondary hover:terminal-primary transition-colors" 
                                title="Copy link">
                            <i class="fas fa-link"></i>
                        </button>
                    </div>
                </div>
            </footer>
        </div>
    </article>
    
    <!-- Related Posts -->
    {% if related_posts %}
    <section class="terminal-window">
        <div class="terminal-header">
            <span class="terminal-primary text-sm font-bold">
                <i class="fas fa-sitemap mr-2"></i>
                related_posts.json
            </span>
        </div>
        
        <div class="p-8">
            <h2 class="text-2xl font-bold terminal-primary mb-6 neon-glow">
                Related Posts
            </h2>
            
            <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                {% for related_post in related_posts %}
                <div class="border border-gray-700 rounded-lg p-6 hover:border-green-400 transition-all duration-300">
                    <h3 class="text-lg font-bold terminal-primary mb-3 hover:neon-glow">
                        <a href="{{ url_for('blog.post', slug=related_post.slug) }}">
                            {{ related_post.title }}
                        </a>
                    </h3>
                    
                    <p class="terminal-text text-sm mb-4 leading-relaxed">
                        {{ related_post.excerpt or (related_post.content[:150] + '...' if related_post.content|length > 150) }}
                    </p>
                    
                    <div class="flex items-center justify-between text-xs terminal-muted">
                        <span>{{ related_post.published_at.strftime('%Y-%m-%d') if related_post.published_at }}</span>
                        <span>{{ related_post.reading_time }} min</span>
                    </div>
                </div>
                {% endfor %}
            </div>
        </div>
    </section>
    {% endif %}
    
    <!-- Navigation -->
    <div class="flex justify-between items-center mt-12">
        <a href="{{ url_for('blog.index') }}" 
           class="terminal-button">
            <i class="fas fa-arrow-left mr-2"></i>
            All Posts
        </a>
        
        <div class="flex space-x-4">
            <a href="{{ url_for('main.portfolio') }}" 
               class="terminal-button">
                <i class="fas fa-folder-open mr-2"></i>
                Portfolio
            </a>
            <a href="{{ url_for('main.contact') }}" 
               class="terminal-button">
                <i class="fas fa-envelope mr-2"></i>
                Contact
            </a>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Copy to clipboard function
    window.copyToClipboard = function(text) {
        navigator.clipboard.writeText(text).then(function() {
            // Show temporary success message
            const btn = event.target.closest('button');
            const icon = btn.querySelector('i');
            const originalClass = icon.className;
            
            icon.className = 'fas fa-check';
            btn.style.color = 'var(--terminal-primary)';
            
            setTimeout(() => {
                icon.className = originalClass;
                btn.style.color = '';
            }, 2000);
        }).catch(function(err) {
            console.error('Could not copy text: ', err);
        });
    };
    
    // Enhanced markdown rendering for code blocks
    const codeBlocks = document.querySelectorAll('pre code');
    codeBlocks.forEach(block => {
        // Add copy button to code blocks
        const pre = block.parentElement;
        const copyBtn = document.createElement('button');
        copyBtn.className = 'absolute top-2 right-2 px-2 py-1 bg-gray-800 text-xs terminal-secondary hover:terminal-primary transition-colors rounded';
        copyBtn.innerHTML = '<i class="fas fa-copy mr-1"></i>Copy';
        copyBtn.onclick = () => {
            navigator.clipboard.writeText(block.textContent);
            copyBtn.innerHTML = '<i class="fas fa-check mr-1"></i>Copied!';
            setTimeout(() => {
                copyBtn.innerHTML = '<i class="fas fa-copy mr-1"></i>Copy';
            }, 2000);
        };
        
        pre.style.position = 'relative';
        pre.appendChild(copyBtn);
    });
    
    // Smooth scroll for anchor links
    const anchorLinks = document.querySelectorAll('a[href^="#"]');
    anchorLinks.forEach(link => {
        link.addEventListener('click', function(e) {
            e.preventDefault();
            const target = document.querySelector(this.getAttribute('href'));
            if (target) {
                target.scrollIntoView({
                    behavior: 'smooth',
                    block: 'start'
                });
            }
        });
    });
    
    // Reading progress indicator
    const article = document.querySelector('article');
    const progressBar = document.createElement('div');
    progressBar.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 0%;
        height: 3px;
        background: var(--terminal-primary);
        z-index: 1000;
        transition: width 0.3s ease;
    `;
    document.body.appendChild(progressBar);
    
    window.addEventListener('scroll', function() {
        const articleRect = article.getBoundingClientRect();
        const windowHeight = window.innerHeight;
        const articleHeight = article.offsetHeight;
        
        let progress = 0;
        if (articleRect.top < windowHeight && articleRect.bottom > 0) {
            const visibleHeight = Math.min(articleRect.bottom, windowHeight) - Math.max(articleRect.top, 0);
            progress = (visibleHeight / Math.min(articleHeight, windowHeight)) * 100;
        }
        
        progressBar.style.width = Math.min(progress, 100) + '%';
    });
    
    // Animate related posts
    const relatedPosts = document.querySelectorAll('.grid .border');
    relatedPosts.forEach((post, index) => {
        post.style.transform = 'translateY(20px)';
        post.style.opacity = '0';
        post.style.transition = 'all 0.6s ease';
        
        setTimeout(() => {
            post.style.transform = 'translateY(0)';
            post.style.opacity = '1';
        }, index * 100);
    });
});
</script>

<!-- Custom styles for markdown content -->
<style>
#post-content {
    line-height: 1.8;
}

#post-content h1,
#post-content h2,
#post-content h3,
#post-content h4,
#post-content h5,
#post-content h6 {
    color: var(--terminal-primary);
    margin-top: 2rem;
    margin-bottom: 1rem;
    font-weight: bold;
}

#post-content h1 { font-size: 2rem; }
#post-content h2 { font-size: 1.75rem; }
#post-content h3 { font-size: 1.5rem; }
#post-content h4 { font-size: 1.25rem; }

#post-content p {
    margin-bottom: 1.5rem;
}

#post-content ul,
#post-content ol {
    margin-bottom: 1.5rem;
    padding-left: 2rem;
}

#post-content li {
    margin-bottom: 0.5rem;
}

#post-content blockquote {
    border-left: 4px solid var(--terminal-primary);
    padding-left: 1.5rem;
    margin: 2rem 0;
    font-style: italic;
    color: var(--terminal-secondary);
}

#post-content code {
    background: rgba(0, 255, 0, 0.1);
    padding: 0.25rem 0.5rem;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    color: var(--terminal-primary);
    font-size: 0.9em;
}

#post-content pre {
    background: #000;
    border: 1px solid var(--terminal-border);
    border-radius: 8px;
    padding: 1.5rem;
    margin: 2rem 0;
    overflow-x: auto;
}

#post-content pre code {
    background: none;
    padding: 0;
    color: var(--terminal-text);
}

#post-content a {
    color: var(--terminal-secondary);
    text-decoration: underline;
    transition: color 0.3s ease;
}

#post-content a:hover {
    color: var(--terminal-primary);
}

#post-content img {
    max-width: 100%;
    height: auto;
    border-radius: 8px;
    margin: 2rem auto;
    display: block;
    border: 2px solid var(--terminal-border);
}

#post-content table {
    width: 100%;
    border-collapse: collapse;
    margin: 2rem 0;
}

#post-content th,
#post-content td {
    border: 1px solid var(--terminal-border);
    padding: 0.75rem;
    text-align: left;
}

#post-content th {
    background: var(--terminal-surface);
    color: var(--terminal-primary);
    font-weight: bold;
}
</style>
{% endblock %}